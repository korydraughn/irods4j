name: run-tests-pam

on: [push, pull_request]

jobs:
  run_tests:
    name: "Testing (PAM) - iRODS 5"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Compose
        uses: docker/setup-compose-action@v1

      - name: Create TLS certificates
        run: |
          # Create the certificates directory in the directory which holds the docker compose
          # YAML files. This is required due to the use of relative paths in the YAML file.
          tls_certs_dir=src/test/resources/docker/tls_certs
          mkdir ${tls_certs_dir}
          cd ${tls_certs_dir}

          key_file=irods_server.key
          openssl genrsa -out ${key_file} 2048
          openssl req -batch -new -x509 -key ${key_file} -out irods_server.crt -days 1
          openssl dhparam -2 -out irods_dhparams.pem 2048

      - name: Build PAM module and user database
        run: |
          sudo apt-get update -qq
          sudo apt-get install -qq build-essential db-util libpam0g-dev

          # The files generated by this step are volume mounted into the docker container running
          # the iRODS server.

          # Build PAM module for clearing auth tokens.
          cd src/test/resources/docker/pam_auth_support
          gcc -fPIC -fno-stack-protector -o pam_clear_token.o -c pam_clear_token.c
          gcc -shared -o pam_clear_token.so pam_clear_token.o

          # Build user database file - pam_userdb.db
          bash make_user_database.sh

      - name: Launch iRODS server
        run: |
          cd src/test/resources/docker
          # --wait causes this step to wait for services to be running/healthy.
          # --wait-timeout is used to limit the wait time for all services to be running/healthy.
          docker compose -f docker-compose.pam.yml up -d --wait --wait-timeout 60

      - name: Create iRODS account for test user
        run: |
          docker exec -u irods irods4j-testing-irods-catalog-provider-1 iadmin mkuser john rodsuser

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
          cache: maven

      - name: Run Tests - pam_password
        run: |
          mvn test -Dirods.test.pam_password.enable=1 -Dtest=PamPasswordAuthenticationTest

      - name: Run Tests - pam_interactive
        run: |
          mvn test -Dirods.test.pam_interactive.enable=1 -Dtest=PamInteractiveAuthenticationTest

      - name: Stop Docker Compose services
        if: always()
        run: |
          cd src/test/resources/docker
          docker compose -f docker-compose.pam.yml down
